### 什么是虚拟内存地址？

> 进程虚拟内存空间中的每一个字节都有与其对应的虚拟内存地址，一个虚拟内存地址表示进程虚拟内存空间中的一个特定的字节。

64 位虚拟地址的格式为：全局页目录项（9位）+ 上层页目录项（9位）+ 中间页目录项（9位）+ 页表项（9位）+ 页内偏移（12位）。共 48 位组成的虚拟内存地址

### 为什么要使用虚拟地址访问内存

直接使用物理内存地址会发生什么问题：如多线程中 将会访问同一个变量的物理地址 出现地址冲突。

虚拟内存引入之后，每个进程都拥有自己独立的虚拟地址空间，进程与进程之间的虚拟内存地址空间是相互隔离，互不干扰的。每个进程都认为自己独占所有内存空间。

**虚拟内存能够提供内存地址空间的隔离**，极大地扩展了可用空间。

当 CPU 访问进程的虚拟地址时，经过**地址翻译硬件将虚拟地址转换成不同的物理地址**。



程序加载流程：

1. 二进制机器码加载到虚拟内存空间  -   代码段
2. 在程序运行之前，全局变量也需要被加载进内存中供程序访问。虚拟内存空间中也需要一段区域来存储这些全局变量。
   1. 那些在代码中被我们**指定了初始值的全局变量和静态变量**在虚拟内存空间中的存储区域我们叫做**数据段**。
   2. 那些没**有指定初始值的全局变量和静态变量**在虚拟内存空间中的存储区域我们叫做 **BSS 段**。这些未初始化的全局变量被**加载进内存之后会被初始化为 0 值。**
   3. 以上是在编译期就确定的。故存储大小是固定的。
3. 在**运行期间往往需要动态的申请内存**，所以在虚拟内存空间中也需要一块区域来存放这些动态申请的内存，这块区域就叫做**堆**。
4. 程序在运行过程中还需要依赖**动态链接库**、这些动态链接库也有自己的对应的代码段，数据段，BSS 段，也需要一起被加载进内存中、还有用于**内存文件映射**的系统调用 mmap，会将文件与内存进行映射，那么映射的这块内存（虚拟内存）也需要在虚拟地址空间中有一块区域存储。**共享内存区**，在虚拟内存空间的存储区域叫做**文件映射与匿名映射区**。
5. 调用**函数过程中使用到的局部变量和函数参数**也需要一块内存区域来保存。这一块区域在虚拟内存空间中叫做**栈**。
6. 内核中使用 start_stack 标识栈的起始位置，RSP 寄存器中保存栈顶指针 stack pointer，RBP 寄存器中保存的是栈基地址。

进程描述符 task_struct 结构中，有一个专门描述进程虚拟地址空间的内存描述符 mm_struct 结构，这个结构体中包含了进程虚拟内存空间的全部信息。