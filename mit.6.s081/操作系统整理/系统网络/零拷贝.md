## 优化文件传输的性能？

**减少上下文切换到次数，减少系统调用的次数**。

如何减少「数据拷贝」的次数？

因为文件传输的应用场景中，在用户空间我们并不会对数据「再加工」，所以数据实际上可以不用搬运到用户空间，因此**用户的缓冲区是没有必要存在的**。

## 如何实现零拷贝？

零拷贝技术实现的方式通常有 2 种：

- mmap + write
  - `mmap()` 系统调用函数会直接把内核缓冲区里的数据「**映射**」到用户空间
  - 操作系统内核与用户空间就不需要再进行任何的数据拷贝操作。
  - 总的来说减少了一次拷贝，但两次上下文切换并未减少。
- sendfile
  - 为了提高文件传输的性能，于是就出现了零拷贝技术，它通过一次系统调用（`sendfile` 方法）合并了磁盘读取与网络发送两个操作，降低了上下文切换次数。另外，拷贝数据都是发生在内核中的，天然就降低了数据拷贝的次数。

零拷贝技术是基于 PageCache 的，PageCache 会缓存最近访问的数据，提升了访问缓存数据的性能，同时，为了解决机械硬盘寻址慢的问题，它还协助 I/O 调度算法实现了 IO 合并与预读，这也是顺序读比随机读性能好的原因。这些优势，进一步提升了零拷贝的性能。

零拷贝技术是不允许进程对文件内容作进一步的加工的，比如压缩数据再发送。

当传输大文件时，不能使用零拷贝，因为可能由于 PageCache 被大文件占据，而导致「热点」小文件无法利用到 PageCache，并且大文件的缓存命中率不高，这时就需要使用「异步 IO + 直接 IO 」的方式。