## 内核

**内核作为应用连接硬件设备的桥梁**

应用程序只需关心与内核交互，不用关心硬件的细节。

### 内核的基本能力

1. 进程、线程管理：创建、调度；
2. 管理内存，分配和回收
3. 管理硬件设备：为进程与硬件设备之间提供通信；
4. 提供系统调用，为应用程序提供更高权限的服务；

内核的权限高，可以控制 cpu、内存、硬盘等硬件，应用程序的权限小，因此大多数操作系统，把内存分成了两个区域：

- 内核空间，这个内存空间只有内核程序可以访问；
- 用户空间，这个内存空间专门给应用程序使用；

用户空间的代码只能访问一个局部的内存空间，而内核空间的代码可以访问所有内存空间。

当程序使用用户空间时，我们常说该程序在**用户态**执行，而当程序使内核空间时，程序则在**内核态**执行。

应用程序如果需要进入内核空间，就需要通过系统调用

系统调用流程：当应用程序使用系统调用时，会产生一个中断。发生中断后， CPU 会中断当前在执行的用户程序，转而跳转到中断处理程序，也就是开始执行内核程序。内核处理完后，主动触发中断，把 CPU 执行权限交回给用户程序，回到用户态继续工作。

### LINUX 基本设计

##### linux主要设计理念：

1. Multi Task：多任务
   1. 可以有多个任务同时执行，这里的「同时」可以是并发或并行：
      - 对于单核 CPU 时，可以让每个任务执行一小段时间，时间到就切换另外一个任务，**从宏观角度看，一段时间内执行了多个任务，这被称为并发。**
      - 对于**多核 CPU 时，多个任务可以同时被不同核心的 CPU 同时执行，这被称为并行。**
2. SMP 对称多处理
   1. 代表着**每个 CPU 的地位是相等的，对资源的使用权限也是相同的**，多个 CPU **共享同一个内存**，**每个 CPU 都可以访问完整的内存和硬件资源。**
   2. 决定了 Linux 操作系统不会有某个 CPU 单独服务应用程序或内核程序，而是**每个程序都可以被分配到任意一个 CPU 上被执行。**
3. ELF 可执行文件链接格式
4. *Monolithic Kernel*，宏内核
   1.  Linux 的内核是一个完整的可执行程序，且拥有最高的权限。
   2. 宏内核的特征是系统内核的所有模块，比如进程调度、内存管理、文件系统、设备驱动等，都运行在内核态。

##### 内核的架构一般有这三种类型：

- 宏内核，包含多个模块，整个内核像一个完整的程序；
- 微内核，有一个最小版本的内核，一些模块和服务则由用户态管理；
- 混合内核，是宏内核和微内核的结合体，内核中抽象出了微内核的概念，也就是内核中会有一个小型的内核，其他模块就在这个基础上搭建，整个内核是个完整的程序；

Linux 的内核设计是采用了宏内核，Window 的内核设计则是采用了混合内核。

这两个操作系统的可执行文件格式也不一样， Linux 可执行文件格式叫作 ELF，Windows 可执行文件格式叫作 PE